<!DOCTYPE html>
<html>

<head>
    <title>Nanonauten in actie</title>
</head>

<body>
    <script>
        // CONSTANTEN
        const CANVAS_BREEDTE = 800;
        const CANVAS_HOOGTE = 600;
        const NANONAUT_BREEDTE = 181;
        const NANONAUT_HOOGTE = 229;
        const GROND_Y = 540;
        const NANONAUT_Y_VERSNELLING = 1;
        const SPATIEBALK_CODE = 32;
        const NANONAUT_SPRONG_SNELHEID = 20;
        const NANONAUT_X_SNELHEID = 5;
        const ACHTERGROND_BREEDTE = 1000;
        const NANONAUT_NR_ANIMATIEFRAMES = 7;
        const NANONAUT_ANIMATIESENELHEID = 5;
        const ROBOT_ANIMATIESNELHEID = 3;
        const ROBOT_NR_ANIMATIEFRAMES = 9;
        const ROBOT_X_SNELHEID = 4;
        const ROBOT_BREEDTE = 141;
        const ROBOT_HOOGTE = 139;

        // INSTELLINGEN
        var canvas = document.createElement('canvas');
        var c = canvas.getContext('2d');
        canvas.width = CANVAS_BREEDTE;
        canvas.height = CANVAS_HOOGTE;
        document.body.appendChild(canvas);

        var nanonautAfbeelding = new Image();
        nanonautAfbeelding.src = 'animatedNanonaut.png';

        var robotAfbeelding = new Image();
        robotAfbeelding.src = 'animatedRobot.png';

        var nanonautSpriteSheet = {
            nrFramesPerRij: 5,
            spriteWidth: NANONAUT_BREEDTE,
            spriteHeight: NANONAUT_HOOGTE,
            image: nanonautAfbeelding
        }

        var robotSpriteSheet = {
            nrFramesPerRij: 3,
            spriteWidth: ROBOT_BREEDTE,
            spriteHeight: ROBOT_HOOGTE,
            image: robotAfbeelding
        }

        var robots = [
            {
                x: 1000,
                y: GROND_Y - ROBOT_HOOGTE,
                frameNr: 0
            }
        ]

        var achtergrondafbeelding = new Image();
        achtergrondafbeelding.src = 'background.png';

        var bush1 = new Image();
        bush1.src = 'bush1.png';
        var bush2 = new Image();
        bush2.src = 'bush2.png';

        var nanonautX = CANVAS_BREEDTE / 2;
        var nanonautY = GROND_Y - NANONAUT_HOOGTE;

        var nanonautYSnelheid = 0;
        var nanonautIsInDeLucht = false

        var spatiebalkIsIngedrukt = false;
        var nanonautFrameNr = 0

        var cameraX = 0;
        var cameraY = 0;

        var spelFrameTeller = 0;

        var bosjes = genereerBosjes();

        window.addEventListener('keydown', onKeyDown);
        window.addEventListener('keyup', onKeyUp);

        window.addEventListener('load', start);

        function start() {
            window.requestAnimationFrame(hoofdLus);
        }

        function genereerBosjes() {
            var gegenereerdeBosjes = [];
            var bosjeX = 0
            while (bosjeX < (2 * CANVAS_BREEDTE)) {
                var bosjeAfbeelding;
                if (Math.random() >= 0.5) {
                    bosjeAfbeelding = bush1;
                } else {
                    bosjeAfbeelding = bush2;
                }

                gegenereerdeBosjes.push({
                    x: bosjeX,
                    y: 80 + Math.random() * 20,
                    image: bosjeAfbeelding
                });
                bosjeX += 150 + Math.random() * 200;
            }
            return gegenereerdeBosjes;
        }

        // HOOFD-LUS
        function hoofdLus() {
            update();
            draw();
            window.requestAnimationFrame(hoofdLus);
        }

        // SPELER HANDELINGEN

        function onKeyDown(event) {
            if (event.keyCode === SPATIEBALK_CODE) {
                spatiebalkIsIngedrukt = true
            }
        }

        function onKeyUp(event) {
            if (event.keyCode === SPATIEBALK_CODE) {
                spatiebalkIsIngedrukt = false
            }
        }

        // UPDATEN
        function update() {

            spelFrameTeller = spelFrameTeller + 1

            if (spatiebalkIsIngedrukt && !nanonautIsInDeLucht) {
                // Springen!
                nanonautYSnelheid = -NANONAUT_SPRONG_SNELHEID
                nanonautIsInDeLucht = true
            }

            nanonautX = nanonautX + NANONAUT_X_SNELHEID;
            nanonautY = nanonautY + nanonautYSnelheid;
            nanonautYSnelheid = nanonautYSnelheid + NANONAUT_Y_VERSNELLING;

            // Update de nanonaut animatie
            if ((spelFrameTeller % NANONAUT_ANIMATIESENELHEID) === 0) {
                nanonautFrameNr = nanonautFrameNr + 1;
                if (nanonautFrameNr >= NANONAUT_NR_ANIMATIEFRAMES) {
                    nanonautFrameNr = 0;
                }
            }

            // Update de robots
            robots.forEach(robot => {
                if ((spelFrameTeller % ROBOT_ANIMATIESNELHEID) === 0) {
                    robot.frameNr = robot.frameNr + 1;
                    if(robot.frameNr >= ROBOT_NR_ANIMATIEFRAMES){
                        robot.frameNr = 0;
                    }
                }
                robot.x = robot.x - ROBOT_X_SNELHEID;
            })


            // Update de camera
            cameraX = nanonautX - 150;

            if (nanonautY > (GROND_Y - NANONAUT_HOOGTE)) {
                nanonautY = GROND_Y - NANONAUT_HOOGTE;
                nanonautYSnelheid = 0;
                nanonautIsInDeLucht = false
            }

            // Update de bosjes
            bosjes.forEach(bosje => {
                if ((bosje.x - cameraX) < -CANVAS_BREEDTE) {
                    bosje.x += (2 * CANVAS_BREEDTE) + 150;
                }
            })

        }

        // TKEKENEN       
        function draw() {
            // Teken de lucht
            c.fillStyle = 'LightSkyBlue';
            c.fillRect(0, 0, CANVAS_BREEDTE, GROND_Y - 40);

            // Teken de achtergrond
            var achtergrondX = -(cameraX % ACHTERGROND_BREEDTE);
            c.drawImage(achtergrondafbeelding, achtergrondX, -210);
            c.drawImage(achtergrondafbeelding, achtergrondX + ACHTERGROND_BREEDTE, -210);


            // Teken de grond
            c.fillStyle = 'ForestGreen';
            c.fillRect(0, GROND_Y - 40, CANVAS_BREEDTE, CANVAS_HOOGTE - GROND_Y + 40);

            // Teken de bosjes
            bosjes.forEach(bosje => {
                c.drawImage(bosje.image, bosje.x - cameraX, GROND_Y - bosje.y - cameraY);
            });

            // Teken de robots
            robots.forEach(robot => {
                tekenGeanimeerdeSprite(robot.x - cameraX, robot.y - cameraY, robot.frameNr, robotSpriteSheet);
            })

            // Teken de Nanonaut
            tekenGeanimeerdeSprite(nanonautX - cameraX, nanonautY - cameraY, nanonautFrameNr, nanonautSpriteSheet);
        }


        // teken een geanimeerde sprite
        function tekenGeanimeerdeSprite(schermX, schermY, frameNr, spriteSheet) {
            var spriteSheetRij = Math.floor(frameNr / spriteSheet.nrFramesPerRij);
            var spriteSheetKolom = frameNr % spriteSheet.nrFramesPerRij;
            var spriteSheetX = spriteSheetKolom * spriteSheet.spriteWidth;
            var spriteSheetY = spriteSheetRij * spriteSheet.spriteHeight;
            c.drawImage(
                // de afbeelding
                spriteSheet.image,
                // de x en y coordinaten in de afbeelding, met de breedte en hoogte in de afbeelding
                spriteSheetX, spriteSheetY, spriteSheet.spriteWidth, spriteSheet.spriteHeight,
                // waar te tekenen op het canvas en met welke breedte en hoogte op de canvas
                schermX, schermY, spriteSheet.spriteWidth, spriteSheet.spriteHeight
            );
        }

    </script>
</body>

</html>